"use strict";!function(){var e=function(e){return JSON.parse(String.fromCharCode.apply(null,new Uint16Array(e)))},r=function(e){for(var r=JSON.stringify(e),n=new ArrayBuffer(2*r.length),t=new Uint16Array(n),o=0,i=r.length;o<i;o++)t[o]=r.charCodeAt(o);return t};window.WorkerOvserve=window.WorkerOvserve||function(){function e(){this._Map=new Map}return e.prototype.observe=function(e,r){var n=this._Map.get(e)||[];n.push(r),this._Map.set(e,n)},e.prototype.unobserve=function(e,r){var n=this._Map.get(e)||[];this._Map.set(e,n.filter(function(e){return e!==r}))},e.prototype.notify=function(e){var r=Array.prototype.slice.call(arguments,1);(this._Map.get(e)||[]).forEach(function(e,n){e.apply(null,r)})},e.prototype["delete"]=function(e){this._Map["delete"](e)},new e}();var n={CHIRIMEN:{PORTS:{283:{portName:"CN1.UART3_RX",pinName:"4"},284:{portName:"CN1.UART3_TX",pinName:"5"},196:{portName:"CN1.SPI0_CS",pinName:"7"},197:{portName:"CN1.SPI0_CLK",pinName:"8"},198:{portName:"CN1.SPI0_RX",pinName:"9"},199:{portName:"CN1.SPI0_TX",pinName:"10"},244:{portName:"CN1.SPI1_CS",pinName:"11"},243:{portName:"CN1.SPI1_CLK",pinName:"12"},246:{portName:"CN1.SPI1_RX",pinName:"13"},245:{portName:"CN1.SPI1_TX",pinName:"14"},163:{portName:"CN2.PWM0",pinName:"10"},193:{portName:"CN2.UART0_TX",pinName:"13"},192:{portName:"CN2.UART0_RX",pinName:"14"},353:{portName:"CN2.GPIO6_A1",pinName:"15"}},I2C_PORTS:{0:{SDA:{portName:"CN2.I2C0_SCL",pinName:"11"},SCL:{portName:"CN2.I2C0_SDA",pinName:"12"}},2:{SDA:{portName:"CN1.I2C2_SDA",pinName:"2"},SCL:{portName:"CN1.I2C2_SCL",pinName:"3"}}}}},t=function(e){this.init(e)};t.prototype={init:function(e){var r=this;this.ports=new i;var t=function(e){return parseInt(e,10)},p=function(e){return function(){return new Promise(function(n){window.WorkerOvserve.observe("gpio.export."+e,function(){return n()}),r.ports.set(e,new o(e))})}},a=function(e,r){return e.then(r)};this.GPIOAccessThen=Object.keys(n.CHIRIMEN.PORTS).map(t).map(p).reduce(a,Promise.resolve())},ports:null,unexportAll:null,onchange:null};var o=function(e){this.init(e)};o.prototype={init:function(e){window.WorkerOvserve.notify("gpio",{method:"gpio.export",portNumber:e}),this.portNumber=e,this.portName="",this.pinName="",this.direction="",this.exported=!1,this.value=null,this._DEVICES="CHIRIMEN"},"export":function(e){var r=this,t=function(e){"function"==typeof r.onchange&&r.onchange(e.value)},o=function(n,o){e===u.OUT||e===u.IN?(window.WorkerOvserve.notify("gpio",{method:"gpio.setDirection",portNumber:r.portNumber,direction:e===u.OUT}),e===u.IN?window.WorkerOvserve.observe("gpio.onchange."+r.portNumber,t):window.WorkerOvserve.unobserve("gpio.onchange."+r.portNumber,t),n()):o(new Error("InvalidAccessError"))},i=function(t){return r.direction=e,r.exported=!0,r.pinName=n[r._DEVICES].PORTS[r.portNumber].pinName,r.portName=n[r._DEVICES].PORTS[r.portNumber].portName,t},p=function(e){return r.direction="",r.exported=!1,r.pinName="",r.portName="",Promise.reject(e)};return new Promise(o).then(i)["catch"](p)},unexport:function(e){},read:function(){var e=this,r=function(r,n){e.exported?e.__isInput()||n(new Error("OperationError")):n(new Error("InvalidAccessError")),r()},n=function(){return new Promise(function(r,n){window.WorkerOvserve.observe("gpio.getValue."+e.portNumber,function(e){r(e.value)}),window.WorkerOvserve.notify("gpio",{method:"gpio.getValue",portNumber:e.portNumber})})};return new Promise(r).then(n)},write:function(e){var r=this,n=function(n,t){r.exported?r.__isOutput()?e!==s.LOW&&e!==s.HIGH&&t(new Error("OperationError")):t(new Error("OperationError")):t(new Error("InvalidAccessError")),n()},t=function(){return r.value=e,window.WorkerOvserve.notify("gpio",{method:"gpio.setValue",portNumber:r.portNumber,value:r.value}),r.value};return new Promise(n).then(t)},onchange:null,__isInput:function(){return this.direction===u.IN},__isOutput:function(){return this.direction===u.OUT}};var i=Map;if(navigator.requestGPIOAccess||(navigator.requestGPIOAccess=function(){var e=new t;return e.GPIOAccessThen.then(function(){return e})}),window.Worker&&window.WorkerOvserve){var p=function(){if(document.currentScript)return document.currentScript.src;var e=document.getElementsByTagName("script"),r=e[e.length-1];return r.src?r.src:void 0}(),a=new Worker(p.substr(0,p.lastIndexOf("/"))+"/worker.gpio.js");window.WorkerOvserve.observe("gpio",function(e){var n=r(e);a.postMessage(n.buffer,[n.buffer])}),a.onmessage=function(r){var n=e(r.data);window.WorkerOvserve.notify(n.method,n)}}var u={IN:"in",OUT:"out"},s={LOW:0,HIGH:1}}();